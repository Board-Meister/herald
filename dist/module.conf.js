var o=class{#r={};#t={};#s=null;constructor(t=null){this.#s=t}async dispatch(t,{origin:r=null}={}){this.#n(t);for(let s of this.#o(t.type,r))try{if(await this.#u(s)(t),this.#e(t))break}catch(i){throw console.error("Dispatcher error:",i),i}}dispatchSync(t,{origin:r=null}={}){this.#n(t);for(let s of this.#o(t.type,r))try{if(this.#u(s)(t),this.#e(t))break}catch(i){throw console.error("Dispatcher error:",i),i}}batch(t){let r=[];return t.forEach(({event:s,subscription:i,constraint:e=null,sort:n=!0,symbol:u=null,anchor:l=null})=>{r.push(this.listen({event:s,subscription:i,constraint:e,sort:n,symbol:u,anchor:l}))}),()=>{r.forEach(s=>{s()})}}listen({event:t,subscription:r,constraint:s=null,sort:i=!0,symbol:e=null,anchor:n=null}){return this.register(t,r,s,i,e,n)}register(t,r,s=null,i=!0,e=null,n=null){e??=this.#c();let u=this.#i(r,s,n),l=this.#l(t,e,u);return i&&this.#h(t),l}unregister(t,r){if(!this.#t[r]){console.warn("Tried to unregister not registered events",t);return}let s=[...this.#r[t]];this.#t[r].forEach(i=>{let e=s.indexOf(i);if(e!==-1)s.splice(e,1);else throw new Error("Attempt to remove event from wrong collection")}),this.#r[t]=s,delete this.#t[r]}#i(t,r=null,s=null){let i=Array.isArray(t)?t:[typeof t=="object"?t:{method:t}],e=[];for(let n of i)e.push({method:n.method,priority:n.priority??0,constraint:n.constraint??r,anchor:n.anchor??s});return e}#l(t,r,s){return this.#r[t]=[...this.#r[t]??[],...s],this.#t[r]=[...this.#t[r]??[],...s],()=>{this.unregister(t,r)}}#c(){return Symbol("event")}#e(t){return t.cancelBubble}#n(t){if(!(t instanceof CustomEvent))throw new Error("Event passed to dispatcher must be of type CustomEvent")}#o(t,r=null){let s=[];for(let i of this.#r[t]??[])this.#a(i,r)&&s.push(i);return s}#a(t,r){return!t.anchor||t.anchor===r||t.anchor.contains(r)}#u(t){let r=t.constraint,s=typeof r=="string"?this.#s?.get(r):r,i=t.method;if(s&&typeof i=="string"&&(i=s[i]??null,i&&(i=i.bind(s))),typeof i!="function")throw console.error("Error below is related to this subscriber",t),new Error("Subscriber doesn't have proper method");return i}#h(t){this.#r[t].sort((r,s)=>r.priority-s.priority)}};var c=class{#r={subscribers:[]};#t;static{this.inject={marshal:"boardmeister/marshal",subscribers:"!subscriber"}}inject(t){this.#r=t,this.#t=new o(this.#r.marshal),this.#s()}dispatch(t,r={}){return this.#t.dispatch(t,r)}dispatchSync(t,r={}){return this.#t.dispatchSync(t,r)}batch(t){return this.#t.batch(t)}listen(t){return this.#t.listen(t)}register(t,r,s=null,i=!0,e=null,n=null){return this.#t.register(t,r,s,i,e,n)}unregister(t,r){return this.#t.unregister(t,r)}#s(){let{marshal:t=null,subscribers:r=[]}=this.#r;r.forEach(s=>{let i=s.module.subscriptions??s.module.constructor?.subscriptions;typeof i=="object"&&this.#i(i)&&Object.keys(i).forEach(e=>{this.#t.listen({event:e,subscription:i[e],constraint:t?.getModuleConstraint(s.config)??null})})})}#i(t){return typeof t=="object"&&!Array.isArray(t)&&t!==null}},h=c,p=h;export{c as HeraldPlugin,p as default};
